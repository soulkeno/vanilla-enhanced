<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minecraft Schematics</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #4c00ff, #00bfff, #4cff00);
    background-size: 400% 400%;
    animation: aurora 15s ease infinite;
    color: #eee;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  @keyframes aurora {
    0% {background-position:0% 50%;}
    50% {background-position:100% 50%;}
    100% {background-position:0% 50%;}
  }

  /* Container */
  .container {
    max-width: 960px;
    margin: 1.5rem auto;
    background: rgba(20, 20, 30, 0.85);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 25px rgb(20 20 30 / 0.7);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1.2px;
  }

  /* User profile on top right */
  #userPfp {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background-color: #6c56d6;
    background-position: center;
    background-size: cover;
    cursor: pointer;
    border: 2px solid #a78cff;
  }
  #loggedUserName {
    margin-left: 12px;
    font-weight: 600;
    user-select: none;
    align-self: center;
    color: #ccc;
  }
  #userContainer {
    display: flex;
    align-items: center;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 1rem;
  }
  .tab {
    cursor: pointer;
    padding: 8px 20px;
    border-radius: 25px;
    background: #392f71cc;
    color: #ddd;
    font-weight: 600;
    user-select: none;
    transition: background-color 0.25s ease, color 0.25s ease;
  }
  .tab:hover {
    background: #6a5ad6;
    color: #fff;
  }
  .tab.active {
    background: #9579e1;
    color: #fff;
    box-shadow: 0 0 12px #9579e1aa;
  }

  /* Sections */
  .tab-section {
    display: none;
    flex-direction: column;
    gap: 1rem;
  }
  .tab-section.active {
    display: flex;
  }

  /* Cards */
  .card {
    background: rgba(255 255 255 / 0.1);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    cursor: default;
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 0 25px #9579e1cc;
  }
  .card img {
    width: 100%;
    max-height: 180px;
    object-fit: cover;
    user-select: none;
  }
  .card-content {
    padding: 12px 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .card-title {
    margin: 0 0 6px 0;
    font-weight: 700;
    font-size: 1.2rem;
    color: #ddd;
  }
  .tag {
    background: #6a5ad6;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 16px;
    width: fit-content;
    user-select: none;
    margin-bottom: 6px;
  }
  .card-desc {
    color: #bbb;
    font-size: 0.9rem;
    flex-grow: 1;
  }

  /* Buttons container in card */
  .buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-start;
    margin-top: 12px;
  }
  /* Buttons style */
  .buttons a.btn,
  .buttons button.btn {
    flex: 0 0 auto;
    min-width: 110px;
    max-width: 140px;
    padding: 8px 18px;
    font-weight: 600;
    font-size: 14px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: background-color 0.25s ease, color 0.25s ease;
    text-align: center;
    text-decoration: none;
    user-select: none;
    display: inline-block;
  }
  .buttons a.btn.download {
    background-color: #6a5ad6;
    color: white;
    box-shadow: 0 0 8px #6a5ad6bb;
  }
  .buttons a.btn.download:hover {
    background-color: #7c69e3;
    box-shadow: 0 0 12px #9579e1cc;
  }
  .buttons button.btn.details {
    background-color: transparent;
    color: #aaa;
    border: 2px solid #6a5ad6;
  }
  .buttons button.btn.details:hover {
    background-color: #6a5ad6;
    color: white;
  }

  /* Login screen */
  #loginScreen {
    position: fixed;
    inset: 0;
    background: rgba(20, 20, 30, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  #loginForm {
    background: #372f71;
    padding: 24px 32px;
    border-radius: 16px;
    box-shadow: 0 0 35px #9579e1aa;
    width: 300px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #loginForm label {
    font-weight: 600;
    color: #eee;
  }
  #loginForm input {
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    font-size: 1rem;
    outline-offset: 2px;
  }
  #loginForm button, #loginGuestBtn {
    margin-top: 12px;
    background-color: #6a5ad6;
    border: none;
    color: white;
    padding: 10px 0;
    font-weight: 700;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  #loginForm button:hover, #loginGuestBtn:hover {
    background-color: #7c69e3;
  }
  #loginGuestBtn {
    background-color: #4a3f8e;
    margin-top: 8px;
  }
  #loginGuestBtn:hover {
    background-color: #5d50b1;
  }

  /* Upload form */
  #uploadForm {
    background: #372f71cc;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 0 15px #9579e1aa;
    max-width: 480px;
    display: none;
    flex-direction: column;
  }
  #uploadForm label {
    margin-top: 8px;
    font-weight: 600;
  }
  #uploadForm input[type="text"],
  #uploadForm textarea,
  #uploadForm select,
  #uploadForm input[type="file"] {
    width: 100%;
    margin-top: 4px;
    padding: 8px 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    outline-offset: 2px;
  }
  #uploadForm textarea {
    resize: vertical;
  }
  #uploadStatus {
    margin-top: 8px;
    font-weight: 600;
    color: #e07c7c;
  }
  #uploadForm button {
    margin-top: 12px;
    padding: 10px 0;
    border: none;
    border-radius: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  #uploadForm button.primary {
    background-color: #6a5ad6;
    color: white;
  }
  #uploadForm button.primary:hover {
    background-color: #7c69e3;
  }
  #uploadForm button.outline {
    background-color: transparent;
    border: 2px solid #6a5ad6;
    color: #6a5ad6;
  }
  #uploadForm button.outline:hover {
    background-color: #6a5ad6;
    color: white;
  }

  /* Details modal */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(10, 10, 15, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20;
  }
  .hidden {
    display: none !important;
  }
  .modal {
    background: #2a2157;
    border-radius: 16px;
    padding: 20px 24px;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    color: #eee;
    box-shadow: 0 0 25px #9579e1cc;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }
  .modal-header h3 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }
  .modal-header button.close {
    background: transparent;
    border: none;
    color: #aaa;
    font-size: 24px;
    cursor: pointer;
  }
  .modal-body img {
    width: 100%;
    max-height: 320px;
    object-fit: contain;
    border-radius: 10px;
    margin-bottom: 12px;
  }
  .modal-footer {
    margin-top: 16px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  .modal-footer a.btn.download {
    padding: 10px 26px;
    font-weight: 700;
    font-size: 1.1rem;
    background-color: #6a5ad6;
    border-radius: 12px;
    box-shadow: 0 0 18px #9579e1cc;
    color: white;
    text-decoration: none;
    user-select: none;
    transition: background-color 0.25s ease;
  }
  .modal-footer a.btn.download:hover {
    background-color: #7c69e3;
    box-shadow: 0 0 28px #b1a7ffcc;
  }
  .modal-footer button.btn.outline {
    background-color: transparent;
    border: 2px solid #6a5ad6;
    color: #6a5ad6;
    font-weight: 700;
    padding: 8px 18px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  .modal-footer button.btn.outline:hover {
    background-color: #6a5ad6;
    color: white;
  }

  /* Profile modal */
  #profileModal .modal-body {
    text-align: center;
  }
  .profile-pic {
    width: 100px;
    height: 100px;
    margin: 0 auto 12px;
    border-radius: 50%;
    background-color: #6c56d6;
    background-position: center;
    background-size: cover;
    cursor: pointer;
    border: 2px solid #a78cff;
  }
  #profileForm label {
    display: block;
    margin-top: 8px;
    font-weight: 600;
    text-align: left;
  }
  #profileForm input,
  #profileForm textarea {
    margin-top: 4px;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    width: 100%;
    font-size: 1rem;
    outline-offset: 2px;
    resize: none;
  }
  #profileForm textarea {
    resize: vertical;
  }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <form id="loginForm" aria-describedby="loginDesc">
    <h2 id="loginTitle" style="color:#eee; text-align:center;">Login to Minecraft Schematics</h2>
    <p id="loginDesc" style="color:#ccc; font-size:0.9rem; margin-bottom:12px; text-align:center;">
      Enter username and password (min 3 chars) or continue as guest.
    </p>
    <label for="loginUsername">Username</label>
    <input type="text" id="loginUsername" name="loginUsername" required autocomplete="off" />
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" name="loginPassword" required autocomplete="off" />
    <button type="submit">Login</button>
    <button type="button" id="loginGuestBtn">Continue as Guest</button>
  </form>
</div>

<div class="container" role="main" aria-live="polite">

  <header>
    <h1>Minecraft Schematics</h1>
    <div id="userContainer" tabindex="-1">
      <div id="userPfp" title="Open profile settings" aria-label="Open profile settings" tabindex="0"></div>
      <span id="loggedUserName">Not logged in</span>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Main navigation">
    <button class="tab active" data-target="main" role="tab" aria-selected="true" tabindex="0">Main Schematics</button>
    <button class="tab" data-target="community" role="tab" aria-selected="false" tabindex="-1">Community</button>
  </nav>

  <section id="main" class="tab-section active" role="tabpanel" tabindex="0" aria-labelledby="mainTab">
    <div id="mainSchematics" class="schematics-grid" aria-live="polite"></div>
  </section>

  <section id="community" class="tab-section" role="tabpanel" tabindex="0" aria-labelledby="communityTab">
    <button id="showUpload" class="btn primary" style="margin-bottom:12px; max-width:180px;">Upload your own</button>

    <form id="uploadForm" aria-label="Upload your schematic">
      <label for="name">Schematic Name</label>
      <input type="text" id="name" name="name" required autocomplete="off" />
      
      <label for="file">Schematic File (.schem, .schematic, .nbt, .msch)</label>
      <input type="file" id="file" name="file" accept=".schem,.schematic,.nbt,.msch" required />

      <label for="image">Preview Image (optional)</label>
      <input type="file" id="image" name="image" accept="image/*" />

      <label for="tag">Tag</label>
      <select id="tag" name="tag" required>
        <option value="" disabled selected>Select tag</option>
        <option value="Farm">Farm</option>
        <option value="Stash">Stash</option>
      </select>

      <label for="description">Description</label>
      <textarea id="description" name="description" rows="4" placeholder="Describe your schematic"></textarea>

      <div id="uploadStatus" aria-live="assertive" style="color: #e07c7c;"></div>

      <button type="submit" class="primary">Upload</button>
      <button type="button" class="outline" id="cancelUpload">Cancel</button>
    </form>

    <div id="communitySchematics" class="schematics-grid" aria-live="polite"></div>
  </section>

</div>

<!-- Details Modal -->
<div id="detailsModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
  <div class="card modal" role="document">
    <div class="modal-header">
      <h3 id="modalTitle">Details</h3>
      <button class="close" id="modalClose" aria-label="Close details modal">✕</button>
    </div>
    <div class="modal-body">
      <img id="modalImage" alt="" />
      <p id="modalDesc" style="white-space: pre-wrap; font-size:14px;"></p>
      <p id="modalTag" style="font-size: 13px; font-weight: 600; margin-top: 6px; color: #bbb;"></p>
    </div>
    <div class="modal-footer">
      <a id="modalDownload" class="btn download" href="#" download>Download</a>
      <button class="btn outline" id="modalCloseFooter">Close</button>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="profileTitle" tabindex="-1">
  <div class="modal" role="document">
    <div class="modal-header">
      <h3 id="profileTitle">Profile Settings</h3>
      <button class="close" id="profileCloseBtn" aria-label="Close profile settings">✕</button>
    </div>
    <div class="modal-body">
      <div id="profilePfp" class="profile-pic" tabindex="0" title="Click to change profile picture"></div>
      <form id="profileForm">
        <label for="profileName">Display Name</label>
        <input type="text" id="profileName" name="profileName" maxlength="20" />
        <label for="profileAbout">About Me</label>
        <textarea id="profileAbout" name="profileAbout" rows="4" maxlength="160" placeholder="Tell others about yourself..."></textarea>
        <input type="file" id="profilePfpFile" name="profilePfpFile" accept="image/*" style="display:none;" />
        <button type="submit" class="primary" style="margin-top:12px;">Save Changes</button>
      </form>
    </div>
  </div>
</div>

<script>
(() => {
  const DEFAULT_PFP = 'https://i.imgur.com/ypu8ZcJ.png'; // Default pfp image (purple circle)
  let schematics = [];
  let user = null;

  // Elements
  const loginScreen = document.getElementById('loginScreen');
  const loginForm = document.getElementById('loginForm');
  const loginGuestBtn = document.getElementById('loginGuestBtn');
  const loggedUserName = document.getElementById('loggedUserName');
  const userPfp = document.getElementById('userPfp');
  const userContainer = document.getElementById('userContainer');

  const tabs = document.querySelectorAll('.tab');
  const tabSections = document.querySelectorAll('.tab-section');

  const mainSchematicsDiv = document.getElementById('mainSchematics');
  const communitySchematicsDiv = document.getElementById('communitySchematics');
  const showUploadBtn = document.getElementById('showUpload');
  const uploadForm = document.getElementById('uploadForm');
  const cancelUploadBtn = document.getElementById('cancelUpload');
  const uploadStatus = document.getElementById('uploadStatus');

  // Details modal
  const detailsModal = document.getElementById('detailsModal');
  const modalClose = document.getElementById('modalClose');
  const modalCloseFooter = document.getElementById('modalCloseFooter');
  const modalImage = document.getElementById('modalImage');
  const modalDesc = document.getElementById('modalDesc');
  const modalTag = document.getElementById('modalTag');
  const modalDownload = document.getElementById('modalDownload');

  // Profile modal
  const profileModal = document.getElementById('profileModal');
  const profileCloseBtn = document.getElementById('profileCloseBtn');
  const profilePfp = document.getElementById('profilePfp');
  const profileForm = document.getElementById('profileForm');
  const profileNameInput = document.getElementById('profileName');
  const profileAboutInput = document.getElementById('profileAbout');
  const profilePfpFileInput = document.getElementById('profilePfpFile');

  // Utility to load from localStorage
  function loadSchematics() {
    try {
      const data = localStorage.getItem('schematics');
      return data ? JSON.parse(data) : [];
    } catch {
      return [];
    }
  }
  function saveSchematics() {
    localStorage.setItem('schematics', JSON.stringify(schematics));
  }
  function loadUser() {
    try {
      const data = localStorage.getItem('user');
      return data ? JSON.parse(data) : null;
    } catch {
      return null;
    }
  }
  function saveUser() {
    if (user) localStorage.setItem('user', JSON.stringify(user));
  }
  function clearUser() {
    localStorage.removeItem('user');
  }

  // Rendering schematic cards
  function createSchematicCard(schematic, isCommunity = false) {
    const card = document.createElement('article');
    card.classList.add('card');
    card.setAttribute('tabindex', '0');
    card.setAttribute('aria-label', `${schematic.name} schematic card`);

    // Image
    const img = document.createElement('img');
    img.alt = schematic.name + ' preview';
    img.src = schematic.image || 'https://i.imgur.com/IyZkZqP.png'; // placeholder image
    card.appendChild(img);

    const content = document.createElement('div');
    content.className = 'card-content';

    const title = document.createElement('h2');
    title.className = 'card-title';
    title.textContent = schematic.name;
    content.appendChild(title);

    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.textContent = schematic.tag;
    content.appendChild(tag);

    const desc = document.createElement('p');
    desc.className = 'card-desc';
    desc.textContent = schematic.description || '';
    content.appendChild(desc);

    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'buttons';

    // Download button
    const downloadBtn = document.createElement('a');
    downloadBtn.className = 'btn download';
    downloadBtn.textContent = 'Download';

    // If community schematic: download file from base64
    if (isCommunity && schematic.fileData) {
      downloadBtn.href = schematic.fileData;
      downloadBtn.download = schematic.name.replace(/\s+/g, '_') + '.schem';
      downloadBtn.setAttribute('role', 'button');
      downloadBtn.setAttribute('aria-label', 'Download ' + schematic.name);
    } else {
      // Placeholder download links for main schematics
      downloadBtn.href = schematic.downloadLink || '#';
      downloadBtn.target = '_blank';
      downloadBtn.rel = 'noopener noreferrer';
      downloadBtn.setAttribute('role', 'button');
      downloadBtn.setAttribute('aria-label', 'Download ' + schematic.name);
    }

    buttonsDiv.appendChild(downloadBtn);

    // Details button
    const detailsBtn = document.createElement('button');
    detailsBtn.className = 'btn details';
    detailsBtn.textContent = 'Details';
    detailsBtn.addEventListener('click', () => openDetailsModal(schematic));
    buttonsDiv.appendChild(detailsBtn);

    content.appendChild(buttonsDiv);

    card.appendChild(content);

    return card;
  }

  // Render all main schematics (placeholders)
  function renderMainSchematics() {
    mainSchematicsDiv.innerHTML = '';
    const placeholders = [
      {
        name: 'Automatic Wheat Farm',
        tag: 'Farm',
        description: 'Efficient wheat farm with pistons and water streams.',
        image: 'https://i.imgur.com/dyMpTpR.jpg',
        downloadLink: '#',
      },
      {
        name: 'Secret Underground Stash',
        tag: 'Stash',
        description: 'Hidden stash with TNT traps and secret doors.',
        image: 'https://i.imgur.com/7ntQg9a.jpg',
        downloadLink: '#',
      },
      {
        name: 'Compact Animal Farm',
        tag: 'Farm',
        description: 'Small but effective animal breeding pen.',
        image: 'https://i.imgur.com/0P1KptN.jpg',
        downloadLink: '#',
      },
    ];
    placeholders.forEach(s => {
      const card = createSchematicCard(s, false);
      mainSchematicsDiv.appendChild(card);
    });
  }

  // Render community schematics
  function renderCommunitySchematics() {
    communitySchematicsDiv.innerHTML = '';
    if (schematics.length === 0) {
      communitySchematicsDiv.textContent = 'No community schematics uploaded yet.';
      return;
    }
    schematics.forEach(s => {
      const card = createSchematicCard(s, true);
      communitySchematicsDiv.appendChild(card);
    });
  }

  // Modal open/close handlers
  function openDetailsModal(schematic) {
    modalImage.src = schematic.image || 'https://i.imgur.com/IyZkZqP.png';
    modalImage.alt = schematic.name + ' preview';
    modalDesc.textContent = schematic.description || 'No description.';
    modalTag.textContent = 'Tag: ' + (schematic.tag || 'None');

    if (schematic.fileData) {
      modalDownload.href = schematic.fileData;
      modalDownload.download = schematic.name.replace(/\s+/g, '_') + '.schem';
      modalDownload.style.display = 'inline-block';
    } else if (schematic.downloadLink) {
      modalDownload.href = schematic.downloadLink;
      modalDownload.target = '_blank';
      modalDownload.rel = 'noopener noreferrer';
      modalDownload.style.display = 'inline-block';
    } else {
      modalDownload.style.display = 'none';
    }

    detailsModal.classList.remove('hidden');
    detailsModal.focus();
  }
  function closeDetailsModal() {
    detailsModal.classList.add('hidden');
  }

  function openProfileModal() {
    profileNameInput.value = user.displayName || user.username;
    profileAboutInput.value = user.about || '';
    profilePfp.style.backgroundImage = `url(${user.pfp || DEFAULT_PFP})`;
    profileModal.classList.remove('hidden');
    profileModal.focus();
  }
  function closeProfileModal() {
    profileModal.classList.add('hidden');
  }

  // Login handling
  function loginUser(u) {
    user = u;
    loggedUserName.textContent = user.displayName || user.username;
    userPfp.style.backgroundImage = `url(${user.pfp || DEFAULT_PFP})`;
    loginScreen.style.display = 'none';
    renderMainSchematics();
    renderCommunitySchematics();
  }

  // Form handlers
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const username = loginForm.loginUsername.value.trim();
    const password = loginForm.loginPassword.value.trim();
    if (username.length < 3 || password.length < 3) {
      alert('Username and password must be at least 3 characters.');
      return;
    }
    // Save user in localStorage as logged in
    user = {
      username,
      displayName: username,
      pfp: DEFAULT_PFP,
      about: '',
    };
    saveUser();
    loginUser(user);
  });
  loginGuestBtn.addEventListener('click', () => {
    user = {
      username: 'Guest',
      displayName: 'Guest',
      pfp: DEFAULT_PFP,
      about: '',
    };
    saveUser();
    loginUser(user);
  });

  // Load user and schematics from localStorage on startup
  function init() {
    schematics = loadSchematics();
    const storedUser = loadUser();
    if (!storedUser) {
      loginScreen.style.display = 'flex';
      loggedUserName.textContent = 'Not logged in';
      userPfp.style.backgroundImage = `url('${DEFAULT_PFP}')`;
    } else {
      user = storedUser;
      loginUser(user);
    }
  }

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
        t.tabIndex = -1;
      });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      tab.tabIndex = 0;
      const target = tab.getAttribute('data-target');
      tabSections.forEach(section => {
        if (section.id === target) {
          section.classList.add('active');
          section.focus();
        } else {
          section.classList.remove('active');
        }
      });
      // Hide upload form when switching tabs
      if (target === 'community') {
        showUploadBtn.style.display = 'inline-block';
        uploadForm.style.display = 'none';
        uploadForm.reset();
        uploadStatus.textContent = '';
      } else {
        showUploadBtn.style.display = 'none';
        uploadForm.style.display = 'none';
      }
    });
  });

  // Upload form handling
  showUploadBtn.addEventListener('click', () => {
    uploadForm.style.display = 'flex';
    showUploadBtn.style.display = 'none';
    uploadStatus.textContent = '';
  });
  cancelUploadBtn.addEventListener('click', () => {
    uploadForm.style.display = 'none';
    showUploadBtn.style.display = 'inline-block';
    uploadForm.reset();
    uploadStatus.textContent = '';
  });

  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = uploadForm.name.value.trim();
    const tag = uploadForm.tag.value;
    const description = uploadForm.description.value.trim();

    if (!name || !tag) {
      uploadStatus.textContent = 'Please enter a name and select a tag.';
      return;
    }

    const fileInput = uploadForm.file;
    const imageInput = uploadForm.image;

    if (!fileInput.files.length) {
      uploadStatus.textContent = 'Please upload your schematic file.';
      return;
    }
    const file = fileInput.files[0];
    // Validate extension
    const allowedExtensions = ['schem', 'schematic', 'nbt', 'msch'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(ext)) {
      uploadStatus.textContent = 'Invalid file type. Allowed: .schem, .schematic, .nbt, .msch';
      return;
    }

    // Read file as base64
    const fileData = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error('Failed to read file'));
      reader.readAsDataURL(file);
    });

    // Read image as base64 if provided
    let imageData = null;
    if (imageInput.files.length) {
      imageData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Failed to read image'));
        reader.readAsDataURL(imageInput.files[0]);
      });
    }

    // Save schematic
    const newSchematic = {
      id: Date.now(),
      name,
      tag,
      description,
      image: imageData,
      fileData,
      uploader: user.username,
    };

    schematics.push(newSchematic);
    saveSchematics();
    renderCommunitySchematics();

    uploadStatus.style.color = '#7ff2a8';
    uploadStatus.textContent = 'Schematic uploaded successfully!';

    // Reset form and hide it
    setTimeout(() => {
      uploadForm.style.display = 'none';
      showUploadBtn.style.display = 'inline-block';
      uploadForm.reset();
      uploadStatus.textContent = '';
    }, 1400);
  });

  // Details modal close buttons
  modalClose.addEventListener('click', closeDetailsModal);
  modalCloseFooter.addEventListener('click', closeDetailsModal);
  detailsModal.addEventListener('click', e => {
    if (e.target === detailsModal) closeDetailsModal();
  });

  // Profile modal close
  profileCloseBtn.addEventListener('click', closeProfileModal);
  profileModal.addEventListener('click', e => {
    if (e.target === profileModal) closeProfileModal();
  });

  // Open profile modal on userPfp click or keyboard enter
  userPfp.addEventListener('click', () => {
    if (user) openProfileModal();
  });
  userPfp.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      if (user) openProfileModal();
    }
  });

  // Profile form save
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const displayName = profileNameInput.value.trim();
    const about = profileAboutInput.value.trim();
    if (displayName.length < 1) {
      alert('Display name cannot be empty.');
      return;
    }
    user.displayName = displayName;
    user.about = about;

    // Save profile pic if changed
    if (profilePfpFileInput.files.length) {
      const imgData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Failed to read image'));
        reader.readAsDataURL(profilePfpFileInput.files[0]);
      });
      user.pfp = imgData;
    }

    saveUser();
    loginUser(user);
    closeProfileModal();
  });

  // Change profile pic preview on clicking profile pic div
  profilePfp.addEventListener('click', () => {
    profilePfpFileInput.click();
  });
  profilePfpFileInput.addEventListener('change', () => {
    if (profilePfpFileInput.files.length) {
      const file = profilePfpFileInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        profilePfp.style.backgroundImage = `url(${reader.result})`;
      };
      reader.readAsDataURL(file);
    }
  });

  // Accessibility: ESC closes modals
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!detailsModal.classList.contains('hidden')) closeDetailsModal();
      if (!profileModal.classList.contains('hidden')) closeProfileModal();
    }
  });

  init();
})();
</script>

</body>
</html>
